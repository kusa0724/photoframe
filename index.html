<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>doudle studio ç•«åšé™å®šé›»å­æ‹è²¼æ©Ÿ - è‡ªå‹•é€£æ‹ç‰ˆ</title>
  <style>
    body { text-align: center; background: #fff; font-family: Arial; }
    h1 { font-size: 32px; padding: 20px; }
    video, canvas { max-width: 95vw; border: 1px solid #ccc; }
    #status { font-size: 24px; color: red; margin: 15px; }
    #startBtn, #downloadBtn { padding: 10px 20px; font-size: 18px; background-color: #ff6666; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
    #startBtn:hover, #downloadBtn:hover { background-color: #ff3333; }
  </style>
</head>

<body>
  <h1>ğŸ“¸ doudle studio ğŸ“¸<br>ç•«åšé™å®šé›»å­æ‹è²¼æ©Ÿ</h1>

  <video id="video" autoplay playsinline></video><br>
  <div id="status">è«‹æŒ‰ä¸‹é–‹å§‹è‡ªå‹•é€£æ‹</div>
  <button id="startBtn">é–‹å§‹è‡ªå‹•é€£æ‹</button><br><br>

  <canvas id="canvas" width="1240" height="1844"></canvas><br><br>

  <button id="downloadBtn" style="display:none;">ä¸‹è¼‰åœ–ç‰‡</button>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const FRAME_SRC = './img/doudle_WINK_frame_A.png'; // æ›æˆä½ ç›¸æ¡†è·¯å¾‘

    let stream;
    let capturedImages = [];
    const totalShots = 4;
    const shotInterval = 8000; // 8ç§’
    let frameImage = new Image();

    async function startCamera() {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
    }

    function startAutoShoot() {
      capturedImages = [];
      let shotCount = 0;
      statusText.innerText = 'é–‹å§‹è‡ªå‹•é€£æ‹ï¼Œæ¯å¼µé–“éš”8ç§’...';
      const shotTimer = setInterval(() => {
        shotCount++;
        capturePhoto();
        statusText.innerText = `å·²æ‹ç¬¬ ${shotCount} å¼µ`;
        if (shotCount === totalShots) {
          clearInterval(shotTimer);
          statusText.innerText = 'âœ… æ‹æ”å®Œæˆï¼Œç”Ÿæˆä¸­...';
          setTimeout(() => generateFinalImage(), 1000);
        }
      }, shotInterval);
    }

    function capturePhoto() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(video, 0, 0);
      const img = new Image();
      img.src = tempCanvas.toDataURL("image/png");
      capturedImages.push(img);
    }

    function generateFinalImage() {
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // å·¦å³å°ç¨±é‡è¤‡æ’æ»¿8æ ¼
      const positions = [
        { x: 70, y: 105, width: 460, height: 320 },
        { x: 630, y: 105, width: 460, height: 320 },
        { x: 70, y: 490, width: 460, height: 320 },
        { x: 630, y: 490, width: 460, height: 320 },
        { x: 70, y: 870, width: 460, height: 320 },
        { x: 630, y: 870, width: 460, height: 320 },
        { x: 70, y: 1255, width: 460, height: 320 },
        { x: 630, y: 1255, width: 460, height: 320 },
      ];

      for (let i = 0; i < 8; i++) {
        const imgToDraw = capturedImages[i % capturedImages.length];
        const pos = positions[i];
        ctx.drawImage(imgToDraw, pos.x, pos.y, pos.width, pos.height);
      }

      frameImage.onload = () => {
        ctx.drawImage(frameImage, 0, 0, 1240, 1844);
        statusText.innerText = 'âœ… å®Œæˆï¼å¯ä¸‹è¼‰åœ–ç‰‡';
        downloadBtn.style.display = 'inline-block';
      };
      frameImage.src = FRAME_SRC;
    }

    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'photobooth.png';
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    startBtn.addEventListener('click', startAutoShoot);

    startCamera();
  </script>
</body>
</html>
