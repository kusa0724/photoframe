<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>doudle studio 畫博限定電子拍貼機 - 自動連拍版</title>
  <style>
    body { text-align: center; background: #fff; font-family: Arial; }
    h1 { font-size: 32px; padding: 20px; }
    video, canvas { max-width: 95vw; border: 1px solid #ccc; }
    #status { font-size: 24px; color: red; margin: 15px; }
    #startBtn, #downloadBtn { padding: 10px 20px; font-size: 18px; background-color: #ff6666; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
    #startBtn:hover, #downloadBtn:hover { background-color: #ff3333; }
  </style>
</head>

<body>
  <h1>📸 doudle studio 📸<br>畫博限定電子拍貼機</h1>

  <video id="video" autoplay playsinline></video><br>
  <div id="status">請按下開始自動連拍</div>
  <button id="startBtn">開始自動連拍</button><br><br>

  <canvas id="canvas" width="1240" height="1844"></canvas><br><br>

  <button id="downloadBtn" style="display:none;">下載圖片</button>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const FRAME_SRC = './img/doudle_WINK_frame_A.png'; // 換成你相框路徑

    let stream;
    let capturedImages = [];
    const totalShots = 4;
    const shotInterval = 8000; // 8秒
    let frameImage = new Image();

    async function startCamera() {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
    }

    function startAutoShoot() {
      capturedImages = [];
      let shotCount = 0;
      statusText.innerText = '開始自動連拍，每張間隔8秒...';
      const shotTimer = setInterval(() => {
        shotCount++;
        capturePhoto();
        statusText.innerText = `已拍第 ${shotCount} 張`;
        if (shotCount === totalShots) {
          clearInterval(shotTimer);
          statusText.innerText = '✅ 拍攝完成，生成中...';
          setTimeout(() => generateFinalImage(), 1000);
        }
      }, shotInterval);
    }

    function capturePhoto() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(video, 0, 0);
      const img = new Image();
      img.src = tempCanvas.toDataURL("image/png");
      capturedImages.push(img);
    }

    function generateFinalImage() {
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // 左右對稱重複排滿8格
      const positions = [
        { x: 70, y: 105, width: 460, height: 320 },
        { x: 630, y: 105, width: 460, height: 320 },
        { x: 70, y: 490, width: 460, height: 320 },
        { x: 630, y: 490, width: 460, height: 320 },
        { x: 70, y: 870, width: 460, height: 320 },
        { x: 630, y: 870, width: 460, height: 320 },
        { x: 70, y: 1255, width: 460, height: 320 },
        { x: 630, y: 1255, width: 460, height: 320 },
      ];

      for (let i = 0; i < 8; i++) {
        const imgToDraw = capturedImages[i % capturedImages.length];
        const pos = positions[i];
        ctx.drawImage(imgToDraw, pos.x, pos.y, pos.width, pos.height);
      }

      frameImage.onload = () => {
        ctx.drawImage(frameImage, 0, 0, 1240, 1844);
        statusText.innerText = '✅ 完成！可下載圖片';
        downloadBtn.style.display = 'inline-block';
      };
      frameImage.src = FRAME_SRC;
    }

    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'photobooth.png';
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    startBtn.addEventListener('click', startAutoShoot);

    startCamera();
  </script>
</body>
</html>
