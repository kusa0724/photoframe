<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>doudle studio ç•«åšé™å®šé›»å­æ‹è²¼æ©Ÿ</title>
  <style>
    body { text-align: center; background: #fff; font-family: Arial; }
    h1 { font-size: 32px; padding: 20px; }
    video, canvas { max-width: 95vw; border: 1px solid #ccc; }
    #status { font-size: 24px; color: red; margin: 15px; }
    #startBtn, #downloadBtn { padding: 10px 20px; font-size: 18px; background-color: #ff6666; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
    #startBtn:hover, #downloadBtn:hover { background-color: #ff3333; }
  </style>
</head>

<body>
  <h1>ğŸ“¸ doudle studio ğŸ“¸<br>ç•«åšé™å®šé›»å­æ‹è²¼æ©Ÿ</h1>

  <video id="video" autoplay playsinline muted></video><br>
  <div id="status">è«‹æŒ‰ä¸‹é–‹å§‹è‡ªå‹•é€£æ‹</div>
  <button id="startBtn">é–‹å§‹è‡ªå‹•é€£æ‹</button><br><br>

  <canvas id="canvas" width="1240" height="1844"></canvas><br><br>

  <button id="downloadBtn" style="display:none;">ä¸‹è¼‰åœ–ç‰‡</button>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const FRAME_SRC = './img/doudle_WINK_frame_A.png'; // ä½ å€‹ç›¸æ¡†è·¯å¾‘

    let stream;
    let capturedImages = [];
    const totalShots = 8;   // 8å¼µ
    const shotInterval = 8000; // æ¯å¼µé–“éš”8ç§’
    let frameImage = new Image();

    const positions = [
      { x: 78, y: 120, width: 490, height: 330 },
      { x: 668, y: 120, width: 490, height: 330 },
      { x: 78, y: 482, width: 490, height: 330 },
      { x: 668, y: 482, width: 490, height: 330 },
      { x: 78, y: 842, width: 490, height: 330 },
      { x: 668, y: 842, width: 490, height: 330 },
      { x: 78, y: 1202, width: 490, height: 330 },
      { x: 668, y: 1202, width: 490, height: 330 }
    ];

    async function startCamera() {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
      video.srcObject = stream;
    }

    function startAutoShoot() {
      capturedImages = [];
      let shotCount = 0;
      takeNextPhoto(shotCount);
    }

    function takeNextPhoto(count) {
      if (count >= totalShots) {
        statusText.innerText = 'ğŸ“¥ æ­£åœ¨è™•ç†ç…§ç‰‡...';
        generateFinalImage();
        return;
      }

      let countdown = 8;
      statusText.innerText = `ğŸ“¸ å€’æ•¸ ${countdown} ç§’å¾Œæ‹ç¬¬ ${count + 1} å¼µ`;
      const timer = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          statusText.innerText = `ğŸ“¸ å€’æ•¸ ${countdown} ç§’å¾Œæ‹ç¬¬ ${count + 1} å¼µ`;
        } else {
          clearInterval(timer);
          capturePhoto();
          statusText.innerText = `âœ… å·²å®Œæˆç¬¬ ${count + 1} å¼µ`;
          setTimeout(() => takeNextPhoto(count + 1), 1000); // 1ç§’å¾Œé€²å…¥ä¸‹ä¸€å¼µå€’æ•¸
        }
      }, 1000);
    }

    function capturePhoto() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(video, 0, 0);
      const img = new Image();
      img.src = tempCanvas.toDataURL("image/png");
      capturedImages.push(img);
    }

    function generateFinalImage() {
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ç¢ºä¿æ¯å¼µç›¸å°æ‡‰æ ¼ä½
      for (let i = 0; i < 8; i++) {
        const imgToDraw = capturedImages[i];
        const pos = positions[i];
        ctx.drawImage(imgToDraw, pos.x, pos.y, pos.width, pos.height);
      }

      // åŠ æ¡†
      frameImage.onload = () => {
        ctx.drawImage(frameImage, 0, 0, 1240, 1844);
        statusText.innerText = 'âœ… å®Œæˆï¼å¯ä¸‹è¼‰åœ–ç‰‡';
        downloadBtn.style.display = 'inline-block';
      };
      frameImage.src = FRAME_SRC;
    }

    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'photobooth.png';
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    startBtn.addEventListener('click', startAutoShoot);

    startCamera();
  </script>
</body>
</html>
